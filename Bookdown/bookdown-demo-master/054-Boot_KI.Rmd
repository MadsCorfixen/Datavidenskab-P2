## Bootstrap-konfidensintervaller

I dette afsnit beskrives, hvorledes konfidensintervallet for en bootstrap-stikprøves beregnes ved hjælp af percentilmetoden, basic-metoden og t-metoden. Til sidst sammenlignes de tre metoders dækningsgrader ved forskellige stikprøvestørrelser.

Et $95\%$ konfidensinterval på en normalfordelt estimator, $\Theta$, kan udregnes ved $\text{KI} = [\hat\theta - 1.96\cdot \text{se}(\hat\theta),~\hat\theta + 1.96\cdot  \text{se}(\hat\theta)]$, [@BootKI]. Hvis ikke fordelingen er kendt, er det ikke muligt at udregne et konfidensinterval således. Her er det i stedet muligt at benytte bootstrap til at udregne et konfidensinterval, hvilket kan gøres ved hjælp af forskellige metoder.

### Percentilmetoden

En intuitiv fremgangsmåde til at bestemme et $(1-\alpha)100\%$ konfidensinterval ved percentiler, er at bruge det $(B(\frac{\alpha}{2}))$'te og $(B(1-\frac{\alpha}{2}))$'te percentil, hvor $B$ er antallet af bootstrap-repetitioner. Lad $\Theta^* = [\vartheta_1,~ \ldots,~\vartheta_B]$ være en sorteret liste af bootstrap-estimater. Derved er formlen for et konfidensinterval på baggrund af percentiler: 

$$\text{KI}_p = \left[q_{(\alpha/2)},~q_{(1-\alpha/2)}\right]$$

Hvor $q_i$ er det $i$'te percentil i $\Theta^*$. [@TPKI]  

__Eksempel__

I kodetstykket nedenfor udtages en tilfældig stikprøve fra en standard normalfordeling. Herefter laves $10,000$ bootstrap-stikprøver, som middelværdien udregnes på. Til sidst sorteres middelværdierne i en liste.

```{r}
data <- rnorm(100, mean = 0, sd = 1) # Tilfældig stikprøve

n <- length(data)
B <- 10000 # Bootstrap-repetitioner

bootstrap_fordeling <- replicate(B, {
  x <- mean(sample(data, size = n, replace = TRUE))
}) # Bootstrap over middelværdien

SortedData <- sort(bootstrap_fordeling) # Bootstrap-fordelinger sorteret

```

Dernæst vælges et konfidensniveau, som regel $90\%$, $95\%$ eller $99\%$.

Bootstrap-konfidensinterval ved hjælp af percentiler kan findes ved:
```{r}
KI_niveau <- 0.95 # Konfidensinterval
alpha <- 1-KI_niveau # Benyttes til percentilerne

IndexLower <- round(B * alpha/2) # Nedre percentil
IndexUpper <- round(B * (1-alpha/2)) # Øvre percentil

KI_Percentil <- c(Lower = SortedData[IndexLower], Upper = SortedData[IndexUpper])
  # Konfidensinterval vha. percentiler

KI_Percentil
```

### Basic-metoden

Denne type konfidensinterval ud fra bootstrap er også kendt som _reversed percentile interval_. Denne metode benytter formlen:

$$\text{KI}_b = \left[2\hat\theta- q_{(1-\alpha/2)}, ~ 2\hat\theta- q_{(\alpha/2)}\right]$$

Hvor $q_i$ er det $i$'te percentil i $\Theta^*$ og $\hat\theta$ er middelværdien af stikprøven, [@BasicKI].

__Eksempel__

I kodestykket nedenfor beregnes middelværdien af stikprøven og benyttes i formlen.

```{r}
theta_hat <- mean(data)

KI_Basic <- c(Lower = 2*theta_hat-SortedData[IndexUpper],
              Upper = 2*theta_hat-SortedData[IndexLower])

KI_Basic
```

### T-metoden

Konfidensintervaller kan også findes ved hjælp af standardfejl fra stikprøven, hvis stikprøven er tilnærmelsesvist t-fordelt.

Formlen for konfidensintervallet er: 

$$\text{KI}_t=\left[\hat\theta-t^{*}_{(1-\alpha/2)}\cdot \hat{\text{se}}(\theta),~\hat\theta-t^{*}_{(\alpha/2)}\cdot\hat{\text{se}}(\theta)\right]$$ 

Hvor $\hat\theta$ er middelværdien af stikprøven, $\hat{\vartheta}$ er middelværdien for $\Theta^*$ og $t^{*}=\frac{\hat{\vartheta}-\hat\theta}{\hat{\text{se}}(\vartheta)}$, [@TPKI].

__Eksempel__

I kodestykket forneden beregnes $t^{*}$ for det nedre og øvre percentil. Dernæst beregnes konfidensintervallet ud fra formlen. 

```{r}
tLower <- (SortedData[IndexUpper]-theta_hat) /
  (sd(bootstrap_fordeling)) # SD udregner standardfejl
tUpper <- (SortedData[IndexLower]-theta_hat) /
  (sd(bootstrap_fordeling)) # SD udregner standardfejl

KI_T <- c(Lower = theta_hat - tLower * (sd(data)/sqrt(n)),
               Upper = theta_hat - tUpper * (sd(data)/sqrt(n)))
KI_T
```

### Dækningsgrader

```{r echo = FALSE, include = FALSE}
library(boot)
```

I dette afsnit vil der undersøges om metoderne for at udregne konfidensintervallerne med bootstrap er præcise. Dette gøres ved at udregne dækningsgraden af konfidensintervallerne som de forskellige metoder har produceret. Processen er den samme som i afsnit \@ref(t-test2). 

Som det første oprettes en funktion, der udregner middelværdien for stikprøven, og tager en stikprøve og et indeks som _input_.

```{r}
meanFunc <- function(d, i) 
{    m <- mean(d$data[i])
     n <- length(i)
     v <- (n-1)*var(d$data[i])/n^2
     c(m, v)
}
sand_middel <- 0 #Sand middelværdi
```

Det næste der udregnes er et konfidensinterval. Konfidensintervallet beregnes ved hjælp af funktionen ```boot.ci```, der kommer fra pakken ```boot```. Der bliver først lavet 100 konfidensintervaller på baggrund af normalfordelte stikprøver. Så undersøges der om middelværdien af populationen er i konfidensintervallet. Hvis det er tilfældet, vil _outputtet_ være ```TRUE```, hvis ikke vil det være ```FALSE```. Herefter indsættes disse _output_ i en matrix. Til sidst beregnes dækningsgraden som andelen af de intervaller, der indeholder den sande middelværdi. Der laves 100 konfidensintervaller for hver stikprøvestørrelse. Stikprøvestørrelsen er angivet i en sekvens fra 4 til 100 med spring på 4. Denne proces udføres for de tre konfidensintervalmetoder, percentil, T og basic.

Her udføres processen for dækningsgraden på percentilmetoden.
```{r}
matriks_p <- matrix(ncol = 25, nrow = 100)
vector_p <- c()
for(n in seq(4, 100, 4)){ #Stikprøve størrelse sekvens
  res <- replicate(100,{
    stik <- data.frame(data = rnorm(n)) #Stikprøven bliver taget fra en normalfordeling
    boot_stik <- boot(stik, statistic = meanFunc, 100) #Der tages 100 bootstrap stikprøver 
    interval_perc <- suppressWarnings(boot.ci(boot_stik, type = c("perc"))$percent[4:5]) #Konfidensintervallet
    tf <- interval_perc[1]<=sand_middel & interval_perc[2]>=sand_middel 
  })
  matriks_p[,n/4] <- res
  vector_p <- append(vector_p, mean(matriks_p[,n/4]))
}
```

```{r}
vector_p
```

I _vector_p_ ses middelværdierne for dækningsgraden af 100 konfidensintervaller genereret ud fra percentilmetoden. Den første middelværdi er for stikprøvestørrelse fire, hvorefter der springes i et interval på fire indtil der nåes ind stikprøvestørrelse på 100.

Her udføres processen for dækningsgraden på basic-metoden.
```{r}
matriks_b <- matrix(ncol = 25, nrow = 100)
vector_b <- c()
for(n in seq(4, 100, 4)){
  res <- replicate(100,{
    stik <- data.frame(data = rnorm(n))
    boot_stik <- boot(stik, statistic = meanFunc, 100)
    interval_basic <- suppressWarnings(boot.ci(boot_stik, type = c("basic"))$basic[4:5])
    tf <- interval_basic[1]<=sand_middel & interval_basic[2]>=sand_middel
  })
  matriks_b[,n/4] <- res
  vector_b <- append(vector_b, mean(matriks_b[,n/4]))
}
```

Til sidst udføres processen for dækningsgraden på T-metoden.
```{r}
matriks_t <- matrix(ncol = 25, nrow = 100)
vector_t <- c()
for(n in seq(4, 100, 4)){
  res <- replicate(100,{
    stik <- data.frame(data = rnorm(n))
    boot_stik <- boot(stik, statistic = meanFunc, 100)
    interval_t <- boot.ci(boot_stik, type = c("stud"))$student[4:5]
    tf <- interval_t[1]<=sand_middel & interval_t[2]>=sand_middel
  })
  matriks_t[,n/4] <- res
  vector_t <- append(vector_t, mean(matriks_t[,n/4]))
}
```

Nu kan dækningsgraderne for de tre metoder illustreres i diagrammet på figur \@ref{fig:figur-deakning}.
```{r figur-daekning, fig.cap = "Dækningsgraden for de tre konfidensintervaller udarbejdet ved hjælp af bootstraps. På x-aksen ses stikprøve størrelsen, mens på y-aksen ses dækningsgraden af konfidensintervallet på baggrund af den givne stikprøve størrelse. 0.95 er det ønsket konfidenslevel."}
x <- seq(4, 100, 4)
plot(x, vector_p, type="l", col="red", ylab = "Dækningsgrad",
     xlab = "Stikprøvestørrelse", ylim = c(0.75, 1))
lines(x, vector_b, type="l", col="blue")
lines(x, vector_t, type="l", col="green")
abline(h=0.95, lty=5, col="black")
legend(83, 0.835, legend=c("Percentil", "Basic", "t"),
       col=c("red", "blue", "green"), lty=c(1,1,1), cex=0.8)
```

Her tyder det på, at T-metoden præsterer bedre ved mindre stikprøver end både percentilmetoden og basic-metoden. Ved omkring $n=15$ når percentil- og basic-metodens konfidensinterval begge den samme dækningsgrad som T-metoden, og generelt kan der ses, at percentil- og basic-metoden har cirka den samme dækningsgrad. 
