## Bootstrap-hypotesetest

```{r, include=FALSE}
library(mosaic)
set.seed(29)
```

Som nævnt i afsnit \@ref(t-test), skal visse antagelser være opfyldt, for at garantere korrektheden af resultaterne af en t-test, og det efterfølgende resultatet af overtrædelsen af disse antagelser, blev vist i afsnit \@ref(t-test2).

Når disse antagelser ikke er opfyldt, kan bootstrap anvendes til at udføre t-test, og i så fald kaldes det i det følgende for en bootstrap-test. I følgende to afsnit gennemgås først fremgangsmåden for en parret bootstrap-test, og dernæst fremgangsmåden for en uparret bootstrap-test.

### Uparret bootstrap-test

Lad to uafhængige uparrede stikprøver, $X=[x_{1},~x_{2},~...,~x_{n_1}]$ og $Y=[y_{1},~y_{2},~...,~y_{n_2}]$, med ens varians være givet på figur \@ref(fig:histhypuparret).

```{r}
n1 <- 20
n2 <- 50
alfa1 <- 2
beta1 <- 8

stik1 <- rbeta(n1, alfa1, beta1)
stik2 <- rbeta(n2, alfa1, beta1)
```

```{r histhypuparret, fig.cap = "To uafhængige uparrede stikprøver", echo = FALSE}
par(mfrow = c(1,2))
hist(stik1, main = "", xlab = "Stikprøve 1", ylab = "Antal observationer", ylim = c(0, 20))
hist(stik2, main = "", xlab = "Stikprøve 2", ylab = "Antal observationer", ylim = c(0, 20))
```

Så opstilles der en nulhypotese, $H_0: \mu_{_X} = \mu_{_Y}$, hvor $\mu_{_X}$ og $\mu_{_Y}$ er de sande middelværdier for populationerne, hvorfra stikprøverne blev udtrukket og en alternativ hypotese, $H_1: \mu_{_X} \neq \mu_{_Y}$, samt et signifikansniveau, $\alpha = 0.05$. 

På baggrund af forskellen i de to stikprøvers middelværdi, er det muligt at udregne en teststørrelse, $t_{obs} = \frac{\bar{X}-\bar{Y}}{\hat{SE}(X)+\hat{SE}(Y)}$.

```{r}
t_obs <- ((mean(stik1) - mean(stik2)) - (0)) /
            sqrt(((sd(stik1))^2 / n1)) +
              ((sd(stik2))^2 / n2)
t_obs
```

Først forenes de to stikprøver til en samlet stikprøve med størrelsen $n_1 + n_2$ observationer. Derefter laves en bootstrap-stikprøve af $n_1 + n_2$ observationer med tilbagelægning fra den samlede stikprøve. Herefter udregnes middelværdien af de første $n_1$ observationer, som kaldes $\hat{X}^*$. Desuden udregnes middelværdien af de resterende $n_2$ observationer, der kaldes $\hat{Y}^*$. Til sidst udregnes bootstrap-teststørrelsen $t^*=\frac{\hat{X}^*-\hat{Y}^*}{\hat{SE}(X^*)+\hat{SE}(Y^*)}$. I alt beregnes der $B$ bootstrap-teststørrelser, [@BootHypo].

```{r}
B <- 1000
boot_t <- replicate(B, {
  
    boot <- sample(c(stik1, stik2), replace = TRUE)
  
    bootx <- boot[1 : n1]
    booty <- boot[(n1+1) : (n1+n2)]
  
    boot_test <- ((mean(bootx) - mean(booty)) -
                    (mean(stik1) - mean(stik2))) /
                      sqrt(((sd(bootx))^2 / n1)) +
                        ((sd(booty))^2 / n2)
})
```

Bootstrap-teststørrelserne ses på figur \@ref(fig:boothypuparret), hvor den observerede teststørrelse er markeret med en blå linje, og bootstrap-teststørrelse-fordelingens middelværdi er markeret med en grøn linje.

```{r boothypuparret, echo = FALSE, fig.cap = "Bootstrap-teststørrelse-fordelingen, hvor den blå linje markerer den observerede teststørrelse, og den grønne linje markerer fordelingens middelværdi."}
hist(boot_t, main = "", ylab = "Antal observationer", xlab = "Bootstrap teststørrelse")
t_boot <- mean(boot_t)
abline(v = t_obs, col = "blue")
abline(v = t_boot, col = "green")
```

Herefter kan p-værdien udregnes som ved permutationstest i afsnit \@ref(permutationstest). 

```{r}
# antal_mindre <- boot_t <= t_obs
# antal_stoerre <- boot_t >= t_obs
# 
# p_1 <- sum(antal_mindre)/B
# p_2 <- sum(antal_stoerre)/B
# p_vaerdi <- min(2*p_1, 2*p_2)
# p_vaerdi

antal_ekstreme <- abs(boot_t) >= t_obs
table(antal_ekstreme)

p_vaerdi <- (sum(antal_ekstreme)+1) / (B + 1)
p_vaerdi
```

Med en p-værdi på ```r round(p_vaerdi, 2)```, kan $H_0$ ikke forkastes, da der ikke er evidens for at middelværdierne for de to populationer er forskellige. Dette resultat stemmer overens med figur \@ref(fig:boothypuparret), da bootstrap-teststørrelsernes middelværdi er tæt på den observerede teststørrelse. 

__Eksempel__

Den udførte test kan ved hjælp af R's funktion ```replicate```, gentages mange gange, for at undersøge om resultatet vil blive det samme, ved mange stikprøveudtagninger. Fremgangsmåden for den uparrede bootstrap-test er den samme. Den bliver blot gentaget $100$ gange, og middelværdien for de $100$ p-værdier findes. Denne p-værdi bruges så til, om nulhypotesen skal forkastes eller ej.

```{r}
reps <- 100
n1 <- 20
n2 <- 50
alfa1 <- 2
beta1 <- 8
B <- 1000

res <- replicate(reps, {
  stik1 <- rbeta(n1, alfa1, beta1)
  stik2 <- rbeta(n2, alfa1, beta1)
  t_obs <- ((mean(stik1) - mean(stik2)) - (0)) /
              sqrt(((sd(stik1))^2 / n1)) + ((sd(stik2))^2 / n2)

  boot_t <- replicate(B, {
  
    boot <- sample(c(stik1, stik2), replace = TRUE)
  
    bootx <- boot[1 : n1]
    booty <- boot[(n1+1) : (n1+n2)]
    boot_test <- ((mean(bootx) - mean(booty)) -
                    (mean(stik1) - mean(stik2))) /
                      sqrt(((sd(bootx))^2 / n1)) +
                        ((sd(booty))^2 / n2)
  })
  
  antal_ekstreme <- abs(boot_t) >= t_obs
  table(antal_ekstreme)

  p_vaerdi <- (sum(antal_ekstreme)+1) / (B + 1)
})

p_vaerdi_uparret <- mean(res)
p_vaerdi_uparret
```

Der ses, at gennemsnits-p-værdien er lig ```r round(p_vaerdi_uparret, 4)```, hvilket er større end signifikansniveauet. Her vil nulhypotesen ikke forkastes, da der ikke er evidens for, at differencen ikke er $0$.

### Parret bootstrap-test

Lad to parrede stikprøver være givet, $X=[x_{1},~x_{2},~...,~x_{n}]$ og $Y=[y_{1},~y_{2},~...,~y_{n}]$.
Der oprettes et tredje datasæt, $Z$, som består af differencerne mellem $x_i$ og $y_i$, $Z = [x_1-y_1,~ x_2-y_2,~...,~x_n-y_n] = [z_1,~z_2,~...,~z_n]$. Ved hjælp af det nye datasæt er det muligt at udregne teststørrelsen, $t_{obs} = \frac{\bar{Z} - \mu_0}{\hat{SE}(Z)}$.

Så opstilles der en nulhypotese, $H_0:~\mu = 0$, hvor $\mu$ angiver den sande middelværdi for $Z$, og en alternativ hypotese, $H_1:~\mu\neq 0$, samt et signifikansniveau, $\alpha = 0.05$. 

Der udtages en bootstrap-stikprøve for $Z$ af $n$ observationer med tilbagelægning, som betegnes $Z^*$. På baggrund af bootstrap-stikprøven for $Z$, kan der nu udregnes $B$ nye teststørrelser, $t^*_i = \frac{\bar{Z}^*_i - \bar{Z}}{\hat{SE}(Z^*_i)}$, hvor $Z^*_i = [z^*_{1,i},~z^*_{2,i},~...,~z^*_{n,i}]$, [@BootvsJack, s. 106, 124-127, 246].

__Eksempel__

I nedenstående kode, vises et eksempel på en parret bootstrap-test, hvor stikprøverne ikke er fra den samme fordeling.

```{r}
reps <- 100
n <- 15
alfa1 <- 10
beta1 <- 2
alfa2 <- 4
beta2 <- 13
B <- 1000

p_reps <- replicate(reps, {
  stik1 <- rgamma(n, alfa1, beta1)
  stik2 <- rgamma(n, alfa2, beta2)
  stik_diff <- stik1 - stik2
  obs_t <- (mean(stik_diff)-0)/(sd(stik_diff)/sqrt(n))

  boot_t <- c()
  for(i in seq(1, B)){
    boot <- sample(stik_diff, n, replace = TRUE)
    boot_t[i] <- (mean(boot)-mean(stik_diff))/(sd(boot)/sqrt(n))
  }
  
  antal_ekstreme <- abs(boot_t) >= obs_t
  
  # antal_mindre <- boot_t <= obs_t
  # antal_stoerre <- boot_t >= obs_t

  # p_1 <- sum(antal_mindre)/B
  # p_2 <- sum(antal_stoerre)/B
  # 
  # p_vaerdi <- 2*min(p_1, p_2)
  
  p_vaerdi <- (sum(antal_ekstreme) + 1) / (B + 1)
})

p_vaerdi_parret <- mean(p_reps)
p_vaerdi_parret
```

Der ses altså at p-værdien er lig ```r p_vaerdi_parret```, hvilket er mindre end signifikansniveauet. Her vil nulhypotesen forkastes, da der er evidens for at differencen ikke er $0$.
